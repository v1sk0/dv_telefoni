<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Service Tickets</title>
  </head>
  <body>
    <h1>Service Tickets</h1>
    <form action="/add_service_ticket" method="POST">
      <label for="customer_name">Customer Name:</label>
      <input
        type="text"
        id="customer_name"
        name="customer_name"
        required
      /><br />

      <label for="customer_contact">Customer Contact:</label>
      <input
        type="text"
        id="customer_contact"
        name="customer_contact"
        required
      /><br />

      <label for="customer_email">Customer Email:</label>
      <input type="email" id="customer_email" name="customer_email" /><br />

      <label for="customer_company_name">Customer Company Name:</label>
      <input
        type="text"
        id="customer_company_name"
        name="customer_company_name"
      /><br />

      <label for="customer_pib">Customer PIB:</label>
      <input type="text" id="customer_pib" name="customer_pib" /><br />

      <label>Service Category:</label><br />
      <input
        type="checkbox"
        id="telefoni"
        name="service_category"
        value="Telefoni"
        required
      />
      Telefoni<br />
      <input
        type="checkbox"
        id="racunari"
        name="service_category"
        value="Racunari"
        required
      />
      Racunari<br />
      <input
        type="checkbox"
        id="ostalo"
        name="service_category"
        value="Ostalo"
        required
      />
      Ostalo<br />

      <label for="brand">Brand:</label>
      <input type="text" id="brand" name="brand" required /><br />

      <label for="model">Model:</label>
      <input type="text" id="model" name="model" required /><br />

      <label for="imei">IMEI/Serial:</label>
      <input type="text" id="imei" name="imei" /><br />

      <label for="comment">Comment:</label>
      <input type="text" id="comment" name="comment" required /><br />

      <input
        type="hidden"
        id="ticket_status"
        name="ticket_status"
        value="Open"
      />

      <label for="sales_price">Sales Price:</label>
      <input type="text" id="sales_price" name="sales_price" required /><br />

      <label for="priority">Priority:</label>
      <select id="priority" name="priority">
        <option value="Normal" selected>Normal</option>
        <option value="Urgent">Urgent</option>
      </select>

      <br />

      <label for="assigned_technician">Assigned Technician name:</label>
      <select id="assigned_technician" name="assigned_technician" required>
          {% for technician in technicians %}
          <option value="{{ technician.name }}">{{ technician.name }}</option>
          {% endfor %}
      </select><br />
      
      

      <label for="attachments">Attachments:</label>
      <input type="file" id="attachments" name="attachments" /><br />

      <label for="service_location">Service Location:</label>
      <select id="service_location" name="service_location" required>
        {% for location in service_locations %}
        <option value="{{ location.id }}">{{ location.name }}</option>
        {% endfor %}</select
      ><br />

      <input type="submit" value="Add Service Ticket" />
    </form>

    <h1>Active Service Tickets {{ open_tickets_count }}  Ukupna suma {{ open_tickets_sales_sum }}</h1>

    <table>
      <thead>
        <tr>
          <th>Ticket Number</th>
          <th>Date</th>
          <th>Customer Name</th>
          <th>Service Section</th>
          <th>Brand</th>
          <th>Model</th>
          <th>Opis kvara</th>
          <th>Status</th>
          <th>Okvirna cena</th>
          <th>Open Duration</th>
          <th>Actions</th>
          <!-- Add more columns as needed -->
        </tr>
      </thead>
      <tbody>
        {% for ticket in service_tickets if ticket.ticket_status == 'Open' %}
        <tr>
          <td>{{ ticket.service_ticket_nr }}</td>
          <td>{{ ticket.date }}</td>
          <td>{{ ticket.customer_name }}</td>
          <td>{{ ticket.service_section }}</td>
          <td>{{ ticket.brand }}</td>
          <td>{{ ticket.model }}</td>
          <td>{{ ticket.comment }}</td>
          <td>{{ ticket.ticket_status }}</td>
          <td>{{ ticket.sales_price }}</td>
          <td>{{ ticket.open_duration }}</td>
          <td>
            {% if ticket.ticket_status == 'Closed' %} Completed {% else %}
            <button class="complete-button" data-ticket-id="{{ ticket.id }}">
              Complete
            </button>
            {% endif %}
          </td>

          <td>
            <!-- Add the print button in each row -->
            <button onclick="printTicket('{{ ticket.id }}')">Print</button>
        </td>

          <!-- Add more columns as needed -->
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <h1>Closed Service Tickets unpaid {{ closed_not_collected_tickets_count }} Ukupna suma {{ closed_tickets_sales_sum }}</h1>
    <table>
      <thead>
        <tr>
          <th>Ticket Number</th>
          <th>Date</th>
          <th>Customer Name</th>
          <th>Service Section</th>
          <th>Brand</th>
          <th>Model</th>
          <th>Opis kvara</th>
          <th>Status</th>
          <th>Complete Duration</th>
          <th>Okvirna cena</th>
          <th>Final Price</th>
          <th>Actions</th>
          <!-- Add more columns as needed -->
        </tr>
      </thead>
      <tbody>
        {% for ticket in service_tickets if ticket.ticket_status == 'Closed' and
        ticket.collected==0 %}
        <tr>
          
          <td>{{ ticket.service_ticket_nr }}</td>
          <td>{{ ticket.date }}</td>
          <td>{{ ticket.customer_name }}</td>
          <td>{{ ticket.service_section }}</td>
          <td>{{ ticket.brand }}</td>
          <td>{{ ticket.model }}</td>
          <td>{{ ticket.comment }}</td>
          <td>{{ ticket.ticket_status }}</td>
          <td class="duration">{{ ticket.complete_duration }}</td>
          <td>{{ ticket.sales_price }}</td>

          <td>
            <input type="number" id="final-price-{{ ticket.id }}" />
            <button class="collect-button" data-ticket-id="{{ ticket.id }}">
              Collect
            </button>
          </td>
          <!-- Add more columns as needed -->
        </tr>
        {% endfor %}
      </tbody>
    </table>
    <script>
      var checkboxes = document.querySelectorAll(
        'input[name="service_category"]'
      );
      checkboxes.forEach(function (checkbox) {
        checkbox.addEventListener("change", function () {
          // Track if any checkbox is checked
          var atLeastOneChecked = false;

          // Check if any checkbox is checked and track the count
          checkboxes.forEach(function (otherCheckbox) {
            if (otherCheckbox.checked) {
              atLeastOneChecked = true;
            }
          });

          // Ensure only one checkbox is checked at a time
          checkboxes.forEach(function (otherCheckbox) {
            if (otherCheckbox !== checkbox) {
              otherCheckbox.checked = false;
            }
          });

          // Pass validation if at least one checkbox is checked
          if (atLeastOneChecked) {
            checkboxes.forEach(function (otherCheckbox) {
              otherCheckbox.required = false;
            });
          } else {
            checkboxes.forEach(function (otherCheckbox) {
              otherCheckbox.required = true;
            });
          }
        });
      });
    </script>

    <script>
      // JavaScript to handle "Complete" button click
      const completeButtons = document.querySelectorAll(".complete-button");
      completeButtons.forEach((button) => {
        button.addEventListener("click", () => {
          if (
            confirm("Are you sure you want to mark this ticket as Complete?")
          ) {
            // Get the ticket ID from data attribute
            const ticketId = button.getAttribute("data-ticket-id");

            // Send a request to update the ticket status and add a closed timestamp to the database
            fetch(`/update_ticket_status/${ticketId}`, {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ newStatus: "Closed" }),
            })
              .then((response) => response.json())
              .then((data) => {
                if (data.success) {
                  // If the update was successful, you can optionally update the UI here
                  // For example, you can change the button text or disable it
                  button.textContent = "Completed";
                  button.disabled = true;

                  // Reload the page after the button click
                  location.reload();
                } else {
                  alert("Failed to update ticket status.");
                }
              })
              .catch((error) => {
                console.error("Error:", error);
              });
          }
        });
      });
    </script>

    <script>
      // JavaScript to handle "Collect" button click
      const collectButtons = document.querySelectorAll(".collect-button");
      collectButtons.forEach((button) => {
          button.addEventListener("click", () => {
              const ticketId = button.getAttribute("data-ticket-id");
              const finalPriceInput = document.getElementById(`final-price-${ticketId}`);
              let finalPrice = parseFloat(finalPriceInput.value);
              
              // Check if final price input is blank
              if (isNaN(finalPrice) || finalPrice === 0) {
                  // Use predefined price if final price input is blank
                  finalPrice = parseFloat(finalPriceInput.getAttribute("data-predefined-price"));
              }
  
              if (confirm(`Are you sure you want to collect this ticket with a final price of $${finalPrice.toFixed(2)}?`)) {
                  fetch(`/collect_ticket/${ticketId}`, {
                      method: "PUT",
                      headers: {
                          "Content-Type": "application/json",
                      },
                      body: JSON.stringify({ finalPrice }),
                  })
                  .then((response) => response.json())
                  .then((data) => {
                      if (data.success) {
                          alert("Ticket collected successfully.");
                          // Reload the page to refresh the tables
                          window.location.reload();
                      } else {
                          alert("Failed to collect ticket.");
                      }
                  })
                  .catch((error) => {
                      console.error("Error:", error);
                  });
              }
          });
      });
  </script>
  
    <script>
      // Get all table cells with the class "duration"
      var durationCells = document.querySelectorAll('.duration');

      // Iterate over each table cell and format the duration
      durationCells.forEach(function(cell) {
          var durationInSeconds = parseInt(cell.innerText);

          // Calculate days, hours, minutes
          var days = Math.floor(durationInSeconds / (3600 * 24));
          var hours = Math.floor((durationInSeconds % (3600 * 24)) / 3600);
          var minutes = Math.floor((durationInSeconds % 3600) / 60);

          // Define the formatted duration string
          var formattedDuration = "";

          // Include days if greater than 0
          if (days > 0) {
              formattedDuration += days + " days, ";
          }

          // Include hours
          formattedDuration += hours + " hours, ";

          // Include minutes
          formattedDuration += minutes + " minutes";

          // Display the formatted duration in the table cell
          cell.innerText = formattedDuration;
      });
  </script>

# Add the JavaScript function for printing the ticket
<script>
  function printTicket(ticketId) {
      // Construct the URL for printing the ticket
      var printUrl = '/print_ticket/' + ticketId;

      // Open a new window/tab for printing
      window.open(printUrl, '_blank');
  }
</script>

</html>
